# https://github.com/neovim/neovim/wiki/Building-Neovim#build-prerequisites
- name: Install pre-requisite packages
  become: true
  apt:
    pkg:
      - cmake
      - ninja-build
      - gettext
      - libtool
      - libtool-bin
      - autoconf
      - automake
      - g++
      - pkg-config
      - unzip
      - curl
      - luajit # required for luarocks.nvim plugin dependencies
      - luarocks # lua package manager required for luarocks.nvim
      - stow # required for linking the ~/.config/nvim

- name: Clone neovim
  git:
    repo: https://github.com/neovim/neovim
    dest: ~/code/neovim/neovim
    version: v0.11.6
    force: true
  register: neovim_changed

- name: Check if neovim is already installed
  stat:
    path: /usr/local/bin/nvim
  register: nvim_installed
  changed_when: false

- name: Build neovim
  import_tasks: build.yml
  when: neovim_changed.before != neovim_changed.after or not nvim_installed.stat.exists

- name: Ensure config folder exists
  file:
    path: ~/.config/nvim
    state: directory

- name: Create symlinks into dotfiles
  command: stow --verbose --target ~/ nvim
  args:
    chdir: ~/code/dotfiles
  changed_when: false  # command module always shows changed; stow is idempotent, failures still detected via exit code

- name: Verify nvim is available before installing plugins
  stat:
    path: /usr/local/bin/nvim
  register: nvim_available
  changed_when: false

- name: Install and update plugins
  command: nvim --headless +PlugUpgrade +PlugInstall +PlugUpdate +qall
  when: nvim_available.stat.exists
