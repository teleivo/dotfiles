---
# https://www.postgresql.org/download/linux/debian/
- name: Download PostgreSQL GPG key
  become: true
  get_url:
    url: "{{ postgresql_gpg_key_url }}"
    dest: /usr/share/keyrings/postgresql.asc
    mode: '0644'
    force: false

- name: Verify PostgreSQL GPG key fingerprint
  command: gpg --show-keys --with-fingerprint /usr/share/keyrings/postgresql.asc
  register: postgresql_gpg_output
  changed_when: false

- name: Check PostgreSQL GPG key fingerprint
  assert:
    that:
      - "postgresql_gpg_key_fingerprint | replace(' ', '') in postgresql_gpg_output.stdout | replace(' ', '')"
    fail_msg: "PostgreSQL GPG key fingerprint verification failed"

- name: Add PostgreSQL apt repository
  become: true
  apt_repository:
    repo: "{{ postgresql_apt_repo }}"
    state: present
    update_cache: true

- name: Mask postgresql service before installing
  become: true
  systemd:
    name: postgresql
    masked: true

- name: Install packages
  become: true
  apt:
    pkg:
      - postgresql-client
      - postgresql-common # for pg_virtualenv
      - postgresql-16
      - python3
      - python3-pip
      - python3-venv # for DHIS2 doc generation
      - pgbadger
      - direnv
      - stow

- name: Ensure postgresql service is disabled (only installed for pg_virtualenv)
  become: true
  systemd:
    name: postgresql
    enabled: false
    state: stopped
    masked: false

- name: Install IntelliJ IDEA Ultimate
  become: true
  snap:
    name: intellij-idea-ultimate
    classic: yes

- name: Ensure DHIS2 folders exist
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - ~/.local/dhis2
    - ~/code/dhis2/

- name: Clone DHIS2 tooling
  git:
    repo: https://github.com/teleivo/dhis2-tooling
    dest: ~/code/dhis2/tooling
    force: no
    remote: my

- name: Link to d2 docker script
  file:
    src: "{{ lookup('env', 'HOME') }}/code/dhis2/tooling/d2"
    dest: "{{ lookup('env', 'HOME') }}/bin/d2"
    state: link

- name: Link to report script in dotfiles
  file:
    src: "{{ lookup('env', 'HOME') }}/code/dhis2/reporting/report"
    dest: "{{ lookup('env', 'HOME') }}/code/dotfiles/bin/bin/report"
    state: link

- name: Ensure config folders exist
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - ~/.config/JetBrains/IntelliJIdea2025.2
    - ~/.config/pgcli

- name: Create symlinks into dotfiles
  command: stow --target ~/ {{ item }}
  args:
    chdir: ~/code/dotfiles
  loop:
    - intellij
    - psql
  changed_when: false  # command module always shows changed; stow is idempotent, failures still detected via exit code

- include_tasks: sops.yml

- include_tasks: kubectl.yml

- include_tasks: awscli.yml
