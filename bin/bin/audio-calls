#!/bin/bash

# Audio calls setup script
# Switches to duplex profile, unmutes mic at 100%, ensures output is unmuted at 30%

# Source common audio utilities
source "$(dirname "$0")/audio-utils"

# Switch to duplex profile for microphone access (only for headsets)
card_id=$(get_headset_card_id)
if [[ -n "$card_id" ]]; then
    pactl set-card-profile "$card_id" output:analog-stereo+input:mono-fallback
fi

# Set microphone to 100% volume and unmute
pactl set-source-volume @DEFAULT_SOURCE@ 100%
pactl set-source-mute @DEFAULT_SOURCE@ 0

# Unmute default sink and ensure minimum 30% volume
pactl set-sink-mute @DEFAULT_SINK@ 0
current_vol=$(pactl get-sink-volume @DEFAULT_SINK@ | grep -oP '\d+%' | head -1 | tr -d '%')
if [[ "$current_vol" -lt 30 ]]; then
    pactl set-sink-volume @DEFAULT_SINK@ 30%
fi

dunstify "Audio Calls" "Calls mode activated - Mic: 100%, Output: unmuted" --icon=audio-headphones