---
- name: Install pre-requisite packages & luarocks
  become: yes
  apt:
    pkg:
      - luarocks
      - ninja-build

- name: Install luacheck
  become: yes
  command: luarocks install luacheck
  args:
    creates: /usr/local/bin/luacheck

- name: Ensure LSP folder exists
  file:
    path: ~/code/lsp
    state: directory

# TODO they now provide a latest release
# https://api.github.com/repos/LuaLS/lua-language-server/releases/latest
# and publish binaries. The binary does need access to some scripts in the published
# tarball. So it might require more work to automate all of that :sigh:
- name: "Clone Lua LSP {{ lsp_release_json.json.tag_name }}"
  git:
    repo: https://github.com/LuaLS/lua-language-server
    dest: ~/code/lsp/lua/lua-language-server
    version: 3.7.1
    recursive: true
    force: true
  register: lsp_lua_changed

- name: Build Lua LSP
  import_tasks: build.yml
  when: lsp_lua_changed.before != lsp_lua_changed.after
