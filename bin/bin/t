#!/bin/bash
#
# Create a new or attach to an existing tmux session named after the basename
# of a directory. The directory selection is done via
# https://github.com/junegunn/fzf
#
# fzf is fed with .git projects using the arg as the initial query. If there is only one match for
# the initial query fzf will not start its interactive finder. The result from fzf is used to open
# a new or attach to an existing session with the projects basename.
#
# You can call/bind this to a key in tmux to open it as a popup or immediately switch to a
# frequently used session.

proj_root="$HOME/code"
proj="$1"

dir=$(fd --unrestricted --exclude target --exclude .terraform --type dir --base-directory "$proj_root" "\.git$" --format "{//}" |
    fzf --reverse --header="Open tmux session for project in "$proj_root" >" --cycle --query "$proj" --select-1)
path_name="$proj_root/${dir}"
session_name=$(basename "$dir")

not_in_tmux() {
  [ -z "$TMUX" ]
}

if not_in_tmux; then
   tmux new-session -As "$session_name" -c "$path_name"
else
  if ! tmux has-session -t "$session_name"; then
    (TMUX='' tmux new-session -Ad -s "$session_name" -c "$path_name")
  fi
  tmux switch-client -t "$session_name"
fi
