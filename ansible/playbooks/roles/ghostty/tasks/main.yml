# https://ghostty.org/docs/install/build#debian-and-ubuntu
# Debian 13+ has sufficient package versions for native build:
# - libadwaita 1.7.6+ (required: 1.5.0+)
# - blueprint-compiler 0.16.0+ (required: 0.16.0+)
- name: Install pre-requisite packages
  become: true
  apt:
    pkg:
      - libgtk-4-dev
      - libgtk4-layer-shell-dev
      - libgtk4-layer-shell0
      - libadwaita-1-dev
      - blueprint-compiler
      - pkg-config
      - gettext
      - libxml2-utils
      - git
      - stow # required for linking the config

- name: Clone
  git:
    repo: https://github.com/ghostty-org/ghostty
    dest: ~/code/ghostty/ghostty
    version: "{{ ghostty_version }}"
    force: true
  register: ghostty_changed

# Snap installation - kept as backup, commented out in favor of native build
# - name: Install zig
#   become: true
#   snap:
#     name: zig
#     classic: true
#     channel: beta
#
# - name: Install ghostty snap
#   become: true
#   snap:
#     name: ghostty
#     classic: true

# Native build - now works on Debian 13+
- name: Remove existing zig snap
  become: true
  snap:
    name: zig
    state: absent
  failed_when: false

- name: Download Zig {{ zig_version }}
  get_url:
    url: https://ziglang.org/download/{{ zig_version }}/zig-x86_64-linux-{{ zig_version }}.tar.xz
    dest: /tmp/zig-{{ zig_version }}.tar.xz
    checksum: "{{ zig_checksum }}"
    mode: '0644'

- name: Extract and install Zig
  shell: |
    tar -xf /tmp/zig-{{ zig_version }}.tar.xz -C ~/.local
    rm -rf ~/.local/zig
    ln -sf ~/.local/zig-x86_64-linux-{{ zig_version }} ~/.local/zig
  args:
    creates: ~/.local/zig-x86_64-linux-{{ zig_version }}/zig

- name: Build
  import_tasks: build.yml

- name: Ensure config folder exists
  file:
    path: ~/.config/ghostty
    state: directory

- name: Create symlinks into dotfiles
  command: stow --target ~/ ghostty
  args:
    chdir: ~/code/dotfiles
