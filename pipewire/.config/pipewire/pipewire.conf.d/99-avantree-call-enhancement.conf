# Avantree C81PC Call Quality Enhancement
# WebRTC echo-cancel with manual connection via systemd service
# This approach uses echo-cancel module but creates connection automatically

context.modules = [
  {
    name = libpipewire-module-echo-cancel
    args = {
      # Use WebRTC echo cancellation library
      library.name = aec/libspa-aec-webrtc

      # Capture properties (microphone input processing)
      capture.props = {
        node.name = "avantree_echo_cancel_capture"
        node.description = "Avantree C81(PC) Echo Cancel Capture"
        media.class = Audio/Sink
        audio.rate = 48000
        audio.channels = 1
        audio.position = [ MONO ]
      }

      # Source properties (enhanced microphone output for applications)
      source.props = {
        node.name = "avantree_echo_cancel_source"
        node.description = "Avantree C81(PC) Microphone (Enhanced)"
        media.class = "Audio/Source"
        audio.rate = 48000
        audio.channels = 1
        audio.position = [ MONO ]
        # Higher priority than raw microphone to become default
        priority.driver = 3100
        priority.session = 3100
        device.intended-roles = "Communication"
      }

      # Sink properties (for echo cancellation output routing)
      sink.props = {
        node.name = "echo-cancel-sink"
        node.description = "Echo-Cancel Sink"
        media.class = "Audio/Sink"
        audio.rate = 48000
        audio.channels = 2
        audio.position = [ FL FR ]
        node.autoconnect = true
        priority.driver = 2500
        priority.session = 2500
      }

      # Playback properties (connects echo-cancel-sink to actual output)
      playback.props = {
        node.name = "echo-cancel-playback"
        node.description = "Echo-Cancel Playback"
        media.class = "Stream/Output/Audio"
        audio.rate = 48000
        audio.channels = 2
        audio.position = [ FL FR ]
        node.autoconnect = true
        node.target = "alsa_output.usb-Avantree*analog-stereo*"
      }

      # WebRTC processing arguments - optimized for call quality
      aec.args = {
        # Noise suppression - reduces background noise and robotic artifacts
        webrtc.noise_suppression = true
        webrtc.noise_suppression.level = 3  # Maximum noise suppression

        # Automatic gain control - normalizes microphone levels
        webrtc.gain_control = true
        webrtc.gain_control.mode = 2  # Adaptive digital AGC

        # Echo cancellation
        webrtc.extended_filter = true
        webrtc.delay_agnostic = true

        # Voice activity detection - improves processing efficiency
        webrtc.voice_detection = true

        # High-pass filter - removes low-frequency noise/rumble
        webrtc.high_pass_filter = true

        # Additional enhancements
        webrtc.limiter = true  # Prevents audio clipping
        webrtc.experimental_agc = false  # Use stable AGC
      }
    }
  }
]