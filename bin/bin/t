#!/bin/sh
#
# Attach or create a tmux session named the same as the current directory or
# one selected using fzf.
#
# No args will open fzf
# Arg '.' will attach a tmux session with the current directory

proj="${1}"
if [ "$proj" = "." ];then
  dir=$(pwd)
  path_name=$(pwd)
elif [ -z "$proj" ]; then
  dir=$(cd ~/code && fd --type d --maxdepth 1 . . lsp dhis2 neovim exercism | sed "s/\.\///g" |
          fzf --reverse --header="Select project from ~/code >")
  path_name="$HOME/code/${dir}"
else
  dir=$(cd ~/code && fd --type d --maxdepth 1 . . lsp dhis2 neovim exercism | sed "s/\.\///g" |
        fzf --reverse --header="Select project from ~/code >" --query "$proj" --select-1)
  path_name="$HOME/code/${dir}"
fi
session_name=$(basename "$dir")

not_in_tmux() {
  [ -z "$TMUX" ]
}

if not_in_tmux; then
   tmux new-session -As "$session_name" -c "$path_name"
else
  if ! tmux has-session -t "$session_name"; then
    (TMUX='' tmux new-session -Ad -s "$session_name" -c "$path_name")
  fi
  tmux switch-client -t "$session_name"
fi
