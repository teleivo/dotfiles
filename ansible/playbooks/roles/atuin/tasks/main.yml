---
- name: Install pre-requisite packages
  become: true
  apt:
    pkg:
      - stow
    state: "{{ apt_package_state }}"

- name: Ensure config folder exists
  file:
    path: ~/.config/atuin
    state: directory

- name: Create symlinks into dotfiles
  command: stow --target ~/ atuin
  args:
    chdir: ~/code/dotfiles
  changed_when: false  # command module always shows changed; stow is idempotent, failures still detected via exit code

- name: Check if atuin is already installed with correct version
  shell: |
    if command -v atuin > /dev/null 2>&1 && atuin --version | grep -q "{{ atuin_version | regex_replace('^v', '') }}"; then
      echo "installed"
    else
      echo "not_installed"
    fi
  register: atuin_version_check
  changed_when: false

- name: Install atuin
  command: cargo install --git https://github.com/atuinsh/atuin.git --tag {{ atuin_version }} --features clipboard --locked
  environment:
    PATH: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"
  when: atuin_version_check.stdout == "not_installed"