#!/usr/bin/env bash
# Focus window from notification click
# Called by mako when a notification is clicked
# Usage: notify-focus NOTIFICATION_ID

set -euo pipefail

# Ensure SWAYSOCK is set (mako doesn't pass environment variables)
if [[ -z "${SWAYSOCK:-}" ]]; then
  SWAYSOCK=$(find /run/user/"$(id -u)" -maxdepth 1 -name 'sway-ipc.*.sock' 2>/dev/null | head -1)
  export SWAYSOCK
fi

# Mako passes the ID via the $id variable in its exec binding
# We need to receive it as a positional parameter
NOTIFICATION_ID="${1:-${id:-}}"

if [[ -z "$NOTIFICATION_ID" ]]; then
  echo "Usage: notify-focus NOTIFICATION_ID (or set \$id variable)" >&2
  exit 1
fi

# Capture notification list once (notification may disappear quickly)
NOTIF_LIST=$(makoctl list)

# Get desktop entry from mako (parse plain text output)
# Desktop entry is more reliable than app name for matching window app_id
# Format: "Notification ID: Summary\n  Desktop entry: name\n  ..."
APP_ID=$(echo "$NOTIF_LIST" | awk -v id="$NOTIFICATION_ID" '
  /^Notification [0-9]+:/ {
    line = $0
    gsub(/[^0-9]/, " ", line)
    split(line, nums, " ")
    current_id = nums[1]
  }
  /^  Desktop entry: / && current_id == id {
    sub(/^  Desktop entry: /, "")
    print
    exit
  }
')

if [[ -z "$APP_ID" ]]; then
  echo "Could not get app-name for notification ID: $NOTIFICATION_ID" >&2
  # Dismiss anyway
  makoctl dismiss -n "$NOTIFICATION_ID" 2>/dev/null || true
  exit 1
fi

# Try to focus window using app_id with various strategies
focus_by_app_id() {
  local app_id="$1"

  # Strategy 1: Exact match
  if swaymsg "[app_id=\"$app_id\"]" focus 2>/dev/null; then
    return 0
  fi

  # Strategy 2: Remove .desktop suffix if present
  local app_id_clean="${app_id%.desktop}"
  if [[ "$app_id_clean" != "$app_id" ]]; then
    if swaymsg "[app_id=\"$app_id_clean\"]" focus 2>/dev/null; then
      return 0
    fi
  fi

  # Strategy 3: Remove node_ prefix (common in notifications)
  local app_id_no_node="${app_id_clean#node_}"
  if [[ "$app_id_no_node" != "$app_id_clean" ]]; then
    if swaymsg "[app_id=\"$app_id_no_node\"]" focus 2>/dev/null; then
      return 0
    fi
  fi

  # Strategy 4: Case-insensitive match
  if swaymsg "[app_id=\"(?i)$app_id_no_node\"]" focus 2>/dev/null; then
    return 0
  fi

  # Strategy 5: Fuzzy match (contains)
  if swaymsg "[app_id=\".*$app_id_no_node.*\"]" focus 2>/dev/null; then
    return 0
  fi

  # Strategy 6: Try common variations
  local variations=(
    "${app_id_no_node,,}"  # lowercase
    "${app_id_no_node^^}"  # uppercase
    "${app_id_no_node^}"   # capitalize first letter
  )

  for variant in "${variations[@]}"; do
    if swaymsg "[app_id=\"$variant\"]" focus 2>/dev/null; then
      return 0
    fi
  done

  # Strategy 7: Try WM_CLASS for X11 apps
  if swaymsg "[class=\"$app_id_no_node\"]" focus 2>/dev/null; then
    return 0
  fi

  return 1
}

# Main logic
if focus_by_app_id "$APP_ID"; then
  # Successfully focused, now dismiss the notification
  makoctl dismiss -n "$NOTIFICATION_ID" 2>/dev/null || true
  exit 0
else
  echo "Failed to find window for app_id: $APP_ID" >&2
  makoctl dismiss -n "$NOTIFICATION_ID" 2>/dev/null || true
  exit 1
fi
