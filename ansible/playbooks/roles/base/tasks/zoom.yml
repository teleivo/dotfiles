---
# Zoom video conferencing client
# Official .deb package with Wayland/XWayland support

- name: Check if Zoom is installed
  ansible.builtin.stat:
    path: /usr/bin/zoom
  register: zoom_installed

- name: Get current Zoom version if installed
  ansible.builtin.command: dpkg-query -W -f='${Version}' zoom
  register: zoom_current_version
  changed_when: false
  failed_when: false
  when: zoom_installed.stat.exists

- name: Download Zoom .deb package
  ansible.builtin.get_url:
    url: "https://cdn.zoom.us/prod/{{ zoom_version }}/zoom_amd64.deb"
    dest: "/tmp/zoom_{{ zoom_version }}_amd64.deb"
    checksum: "{{ zoom_checksum }}"
    mode: '0644'
  when: not zoom_installed.stat.exists or zoom_current_version.stdout != zoom_version
  register: zoom_downloaded

- name: Install Zoom .deb package with automatic dependency resolution
  ansible.builtin.apt:
    deb: "/tmp/zoom_{{ zoom_version }}_amd64.deb"
    state: present
  become: yes
  when: zoom_downloaded.changed
  # Dependencies are automatically resolved from the .deb package's control file
  # To inspect dependencies: dpkg-deb -I zoom_amd64.deb | grep -A 20 "Depends:"

- name: Remove Zoom .deb package after installation
  ansible.builtin.file:
    path: "/tmp/zoom_{{ zoom_version }}_amd64.deb"
    state: absent

- name: Configure Zoom for Wayland/XWayland
  ansible.builtin.copy:
    dest: "{{ ansible_env.HOME }}/.config/zoomus.conf"
    content: |
      [General]
      # Force XWayland for better compatibility
      # Native Wayland support is experimental in Zoom
      enableWaylandShare=false

      # Use system theme
      useSystemTheme=true

      # Hardware acceleration
      conf.webrender.enabled=true
    mode: '0644'
    owner: "{{ ansible_env.USER }}"
    group: "{{ ansible_env.USER }}"
